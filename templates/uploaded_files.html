{% extends "base.html" %}
{% block title %}Uploaded Files{% endblock %}

{% block content %}
<div class="container" style="padding: 18px; max-width:1200px;">
  <h2>Uploaded Files</h2>

  <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center;">
    <input id="searchBox" placeholder="Search file name..." style="padding:8px; width:320px;" />
    <select id="filterExam" style="padding:8px;">
      <option value="">All Exams</option>
      <option value="mid1">Mid-1</option>
      <option value="mid2">Mid-2</option>
      <option value="semester">Semester</option>
    </select>
    <button id="btnRefresh" style="padding:8px;">Refresh</button>
    <span id="status" style="margin-left:12px;"></span>
  </div>

  <table id="filesTable" border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse;">
    <thead style="background:#f2f2f2;">
      <tr>
        <th>#</th>
        <th>File Name</th>
        <th>Original Name</th>
        <th>Exam Type</th>
        <th>Uploaded On</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="filesTbody">
      <!-- populated by JS -->
    </tbody>
  </table>

  <!-- Preview modal -->
  <div id="previewModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.5);">
    <div style="background:#fff; width:90%; max-width:900px; margin:60px auto; padding:16px; border-radius:6px; position:relative;">
      <button id="closePreview" style="position:absolute; right:10px; top:10px;">Close</button>
      <h3 id="previewTitle">Preview</h3>
      <div id="previewMeta" style="font-size:13px; color:#444; margin-bottom:8px;"></div>
      <div id="previewCols" style="font-family:monospace; white-space:pre-wrap;"></div>
      <div id="previewRows" style="margin-top:8px; font-size:13px;"></div>
      <div style="margin-top:12px;">
        <a id="downloadLink" href="#" style="margin-right:8px;">Download File</a>
        <button id="deleteFileFromModal" style="background:#c33;color:#fff;padding:6px;">Delete (DB + file)</button>
      </div>
    </div>
  </div>

  <!-- Confirm delete modal -->
  <div id="confirmModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.5);">
    <div style="background:#fff; width:420px; margin:120px auto; padding:16px; border-radius:6px;">
      <p id="confirmText">Are you sure?</p>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
        <button id="confirmNo">No</button>
        <button id="confirmYes" style="background:#c33; color:#fff; padding:6px;">Yes, delete</button>
      </div>
    </div>
  </div>
</div>

<script>
const apiBase = "/api";
const tbody = document.getElementById("filesTbody");
const searchBox = document.getElementById("searchBox");
const filterExam = document.getElementById("filterExam");
const btnRefresh = document.getElementById("btnRefresh");
const statusSpan = document.getElementById("status");

async function loadFiles() {
  statusSpan.textContent = "Loading...";
  const q = encodeURIComponent(searchBox.value || '');
  const et = encodeURIComponent(filterExam.value || '');
  const resp = await fetch(`${apiBase}/files?q=${q}&exam_type=${et}`);
  const data = await resp.json();
  tbody.innerHTML = "";
  let i = 0;
  for (const item of data.items) {
    i++;
    const tr = document.createElement("tr");
    const uploadedOn = item.uploaded_on ? new Date(item.uploaded_on).toLocaleString() : '';
    tr.innerHTML = `
      <td>${i}</td>
      <td>${escapeHtml(item.file_name)}</td>
      <td>${escapeHtml(item.original_file_name)}</td>
      <td>${escapeHtml(item.exam_type)}</td>
      <td>${escapeHtml(uploadedOn)}</td>
      <td>
        <button class="viewBtn" data-id="${item.id}">View</button>
        <a href="${apiBase}/files/${item.id}/download" style="margin-left:6px;">Download</a>
        <button class="delBtn" data-id="${item.id}" style="margin-left:6px;">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
  statusSpan.textContent = `${data.total || 0} files`;
  attachHandlers();
}

function attachHandlers() {
  document.querySelectorAll(".viewBtn").forEach(btn => {
    btn.onclick = () => openPreview(btn.dataset.id);
  });
  document.querySelectorAll(".delBtn").forEach(btn => {
    btn.onclick = () => askDelete(btn.dataset.id);
  });
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* Preview modal logic */
const previewModal = document.getElementById("previewModal");
const previewCols = document.getElementById("previewCols");
const previewRows = document.getElementById("previewRows");
const previewMeta = document.getElementById("previewMeta");
const previewTitle = document.getElementById("previewTitle");
const downloadLink = document.getElementById("downloadLink");
const deleteFileFromModal = document.getElementById("deleteFileFromModal");

document.getElementById("closePreview").onclick = () => previewModal.style.display = "none";

async function openPreview(id) {
  previewTitle.textContent = "Preview: " + id;
  previewMeta.textContent = "Loading...";
  previewCols.textContent = "";
  previewRows.textContent = "";
  previewModal.style.display = "block";

  const resp = await fetch(`${apiBase}/files/${id}/preview`);
  if (!resp.ok) {
    const err = await resp.json();
    previewMeta.textContent = "Error: " + (err.error || resp.statusText);
    return;
  }
  const data = await resp.json();
  previewMeta.textContent = `${data.meta.file_name} â€” uploaded_on: ${data.meta.uploaded_on}`;
  previewCols.textContent = data.columns.join(", ");
  previewRows.innerHTML = "<strong>First rows:</strong><br/>";
  data.sample_rows.forEach((r, idx) => {
    previewRows.innerHTML += `<div style="font-family:monospace; margin-bottom:6px;"><strong>#${idx+1}</strong> ${JSON.stringify(r)}</div>`;
  });
  downloadLink.href = `${apiBase}/files/${id}/download`;
  deleteFileFromModal.onclick = () => askDelete(id, true);
}

/* Delete confirm logic */
const confirmModal = document.getElementById("confirmModal");
const confirmText = document.getElementById("confirmText");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
let deleteTargetId = null;
let deleteRemoveFile = false;

function askDelete(id, removeFile=false) {
  deleteTargetId = id;
  deleteRemoveFile = removeFile;
  confirmText.textContent = `Delete uploaded file #${id}? Remove file from disk: ${removeFile ? 'YES' : 'NO'}.`;
  confirmModal.style.display = "block";
}
confirmNo.onclick = () => confirmModal.style.display = "none";
confirmYes.onclick = async () => {
  confirmModal.style.display = "none";
  if (!deleteTargetId) return;
  try {
    const resp = await fetch(`${apiBase}/files/${deleteTargetId}?remove_file=${deleteRemoveFile}`, { method: 'DELETE' });
    const data = await resp.json();
    if (resp.ok) {
      alert("Deleted " + deleteTargetId);
      previewModal.style.display = "none";
      loadFiles();
    } else {
      alert("Delete failed: " + (data.error || JSON.stringify(data)));
    }
  } catch (e) {
    alert("Delete failed: " + e.message);
  }
}

btnRefresh.onclick = loadFiles;
searchBox.oninput = () => setTimeout(loadFiles, 300);
filterExam.onchange = loadFiles;

/* initial load */
loadFiles();
</script>
{% endblock %}
